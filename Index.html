<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BoardScope by CW - ABO Practice Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='none' stroke='%233e7cfa' stroke-width='2'/%3E%3Ccircle cx='12' cy='12' r='4' fill='%233e7cfa'/%3E%3C/svg%3E" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #222;
      --button-bg: #3e7cfa;
      --button-text: #fff;
      --progress-bg: #e4e7ea;
      --progress-fg: #3e7cfa;
      --card-bg: #e4e7ea;
      --table-header: #dbeafe;
      --category-color: #3e7cfa;
      --mark-border: #ffca28;
      --mark-button: #ffca28;
      --mark-button-hover: #ffb300;
    }
    .dark {
      --bg-color: #23272f;
      --text-color: #ddd;
      --button-bg: #60a5fa;
      --button-text: #fff;
      --progress-bg: #222;
      --progress-fg: #1d90ff;
      --card-bg: #23272f;
      --table-header: #1e293b;
      --category-color: #60a5fa;
      --mark-border: #ffd54f;
      --mark-button: #ffd54f;
      --mark-button-hover: #ffca28;
    }
    body { font-family: Arial, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); }
    .container { max-width: 640px; margin: 0 auto; padding: 32px 8px; }
    .question { font-size: 1.1em; margin-bottom: 16px; }
    .options button {
      width: 100%; margin-bottom: 8px; padding: 12px;
      font-size: 1em; border-radius: 7px; border: 1px solid #bbb;
      cursor: pointer; background: #fff; color: #222;
      transition: background .2s, color .2s;
    }
    .dark .options button { background: #222; color: #eee; border-color: #555; }
    .options button.correct { background: #19b519; color: #fff; }
    .options button.wrong { background: #ce1818; color: #fff; }
    .progressbar-bg { background: var(--progress-bg); border-radius: 10px; height: 12px; }
    .progressbar-fg { background: var(--progress-fg); height: 100%; border-radius: 10px; transition: width .2s; }
    .controls { margin: 20px 0; display: flex; justify-content: space-between; flex-wrap: wrap; }
    .controls button, .menu-btn { padding: 8px 18px; border-radius: 7px; border: none; background: var(--button-bg); color: var(--button-text); font-size: 1em; cursor: pointer; }
    .menu-btn { float: right; margin-left: 8px; }
    .controls button:disabled { background: #b7b7b7; color: #eee; cursor: default; }
    .setup-panel label { display: block; margin: 18px 0 7px 0; font-weight: 600; }
    .setup-panel select { margin: 10px 0; padding: 8px; font-size: 1em; }
    .setup-panel input[type="checkbox"] { margin-right: 8px; }
    .result-card { background: var(--card-bg); padding: 18px; border-radius: 12px; margin-bottom: 22px; }
    .dark .result-card { color: #e9e9e9; }
    .timer { font-size: 1.13em; font-weight: bold; float: right; }
    .category-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .category-table th, .category-table td { padding: 8px; border-bottom: 1px solid #bbb; }
    .category-table th { background: var(--table-header); }
    .category-table tr:last-child td { border-bottom: none; }
    .category-label { font-size: 0.93em; color: var(--category-color); }
    .header {
      text-align: center; padding: 20px 0;
      background: linear-gradient(to bottom, #e6f0ff 0%, var(--bg-color) 100%);
      position: relative; overflow: hidden;
    }
    .dark .header { background: linear-gradient(to bottom, #1e293b 0%, var(--bg-color) 100%); }
    .header::before {
      content: 'E T A O N R I S H';
      position: absolute; top: 10px; left: 0; right: 0;
      font-size: 10px; letter-spacing: 5px;
      color: rgba(0, 0, 0, 0.1); text-align: center;
      font-family: 'Courier New', monospace;
    }
    .dark .header::before { color: rgba(255, 255, 255, 0.1); }
    .logo-main {
      display: flex; align-items: center; justify-content: center;
      font-family: 'Montserrat', Arial, sans-serif; font-size: 2em;
      font-weight: 700; color: var(--button-bg); margin: 0;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
    .logo-main svg { margin-right: 10px; width: 40px; height: 40px; }
    .logo-main span { font-size: 0.6em; font-weight: 400; margin-left: 5px; }
    .logo-wordmark {
      font-family: 'Montserrat', Arial, sans-serif; font-size: 1.5em;
      font-weight: 600; color: var(--button-bg); margin: 10px 0;
      text-align: center;
    }
    .marked { border: 2px solid var(--mark-border); border-radius: 5px; padding: 10px; position: relative; }
    .mark-flag { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; }
    .mark-btn { background: var(--mark-button); color: #222; margin-right: 8px; }
    .mark-btn:hover { background: var(--mark-button-hover); }
    .review-list, .progress-section { margin-top: 20px; }
    .review-list h3, .progress-section h3 { margin-bottom: 10px; }
    .review-list ul { list-style: none; padding: 0; }
    .review-list li { margin: 5px 0; }
    .review-list a { color: var(--category-color); text-decoration: none; }
    .review-list a:hover { text-decoration: underline; }
    .progress-table { width: 100%; border-collapse: collapse; }
    .progress-table th, .progress-table td { padding: 8px; border-bottom: 1px solid #bbb; }
    .progress-table th { background: var(--table-header); }
    .explanation-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000; max-width: 80%; }
    .explanation-popup p { margin: 0 0 10px 0; }
    .explanation-popup button { background: var(--button-bg); color: var(--button-text); }
    .achievement { color: #19b519; font-weight: bold; margin: 10px 0; }
    #calculatorModal {
      position: absolute; bottom: 20px; right: 20px; width: 320px;
      background: #333; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000; display: none;
    }
    .dark #calculatorModal { background: #444; }
    #calculatorHeader {
      background: #555; color: white; padding: 10px;
      text-align: center; cursor: move; border-radius: 10px 10px 0 0;
    }
    .dark #calculatorHeader { background: #666; }
    #calc-display {
      width: 100%; height: 50px; background: #fff;
      text-align: right; padding: 10px; font-size: 24px;
      box-sizing: border-box; border: 1px solid #ccc;
    }
    .dark #calc-display { background: #eee; }
    #calc-buttons {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 1px; background: #444; padding: 10px;
      border-radius: 0 0 10px 10px;
    }
    .dark #calc-buttons { background: #555; }
    .calc-button {
      padding: 20px; font-size: 18px; border: none;
      background: #666; color: white; cursor: pointer;
      transition: background .2s;
    }
    .dark .calc-button { background: #777; }
    .calc-button:hover { background: #888; }
    .dark .calc-button:hover { background: #999; }
    .operator { background: #ff9500; }
    .dark .operator { background: #ffaa33; }
    .operator:hover { background: #ffb347; }
    .dark .operator:hover { background: #ffbb55; }
    .equals { background: #2196F3; }
    .dark .equals { background: #42a5f5; }
    .equals:hover { background: #64b5f6; }
    .dark .equals:hover { background: #90caf9; }
    #calculatorToggle {
      position: fixed; bottom: 20px; right: 20px;
      padding: 10px 20px; font-size: 16px;
      background: #4CAF50; color: white; border: none;
      border-radius: 5px; cursor: pointer; z-index: 2000;
    }
    .dark #calculatorToggle { background: #66bb6a; }
    #calculatorToggle:hover { background: #45a049; }
    .dark #calculatorToggle:hover { background: #4caf50; }
  
/* Modernized controls */
.controls { display:flex; flex-wrap:wrap; gap:10px; }
.controls button, .menu-btn { border:1px solid rgba(0,0,0,0.08); border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,0.06); padding:10px 14px; }
.controls .menu-btn input[type=file]{ display:none; }

/* Small floating calculator button */
.fab-calc{ position:fixed; bottom:16px; right:16px; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#2a6f97; color:#fff; font-size:22px; box-shadow:0 6px 16px rgba(0,0,0,.2); z-index:999; opacity:.85; }
.fab-calc:hover{ opacity:1; }
#calculatorModal{ max-width:320px; }
</style>
</head>
<body>
  <div class="container" id="app"></div>
  <button id="calculatorToggle" onclick="toggleCalculator()">ðŸ§®</button>
  <div id="calculatorModal">
    <div id="calculatorHeader">Drag Me!</div>
    <input type="text" id="calc-display" value="0" readonly>
    <div id="calc-buttons">
      <button class="calc-button" onclick="calcClear()">C</button>
      <button class="calc-button" onclick="calcBack()">âŒ«</button>
      <button class="calc-button operator" onclick="calcInsert('(')">(</button>
      <button class="calc-button operator" onclick="calcInsert(')')">)</button>
      <button class="calc-button" onclick="calcInsert('7')">7</button>
      <button class="calc-button" onclick="calcInsert('8')">8</button>
      <button class="calc-button" onclick="calcInsert('9')">9</button>
      <button class="calc-button operator" onclick="calcInsert('/')">Ã·</button>
      <button class="calc-button" onclick="calcInsert('4')">4</button>
      <button class="calc-button" onclick="calcInsert('5')">5</button>
      <button class="calc-button" onclick="calcInsert('6')">6</button>
      <button class="calc-button operator" onclick="calcInsert('*')">Ã—</button>
      <button class="calc-button" onclick="calcInsert('1')">1</button>
      <button class="calc-button" onclick="calcInsert('2')">2</button>
      <button class="calc-button" onclick="calcInsert('3')">3</button>
      <button class="calc-button operator" onclick="calcInsert('-')">âˆ’</button>
      <button class="calc-button" onclick="calcInsert('0')">0</button>
      <button class="calc-button" onclick="calcInsert('.')">.</button>
      <button class="calc-button operator" onclick="calcSquare()">xÂ²</button>
      <button class="calc-button operator" onclick="calcInsert('+')">+</button>
      <button class="calc-button operator" onclick="calcSqrt()">âˆš</button>
      <button class="calc-button equals" onclick="calcEquals()" style="grid-column: span 3;">=</button>
    </div>
  </div>
  <script>
    // Paste the contents of abo-script.js here before hosting
let QUESTIONS = [
  // Lens Basics (30 questions, including math)
  { q: "What is the standard pupillary distance range for adults?", o: ["50-70 mm", "30-50 mm", "30-40 mm", "70-80 mm"], a: 0, c: "Lens Basics", e: "Pupillary distance (PD) typically ranges from 50 to 70 mm for adults." },
  { q: "Which lens material has the highest index of refraction?", o: ["CR-39", "Polycarbonate", "Trivex", "High-index 1.74"], a: 3, c: "Lens Basics", e: "High-index 1.74 has the highest refraction index for thinner lenses." },
  { q: "What lens corrects nearsightedness?", o: ["Convex", "Concave", "Bifocal", "Prism"], a: 1, c: "Lens Basics", e: "Concave lenses diverge light to correct myopia (nearsightedness)." },
  { q: "What is the focal length of a +4.00D lens?", o: ["0.25m", "0.5m", "1m", "4m"], a: 0, c: "Lens Basics", e: "Focal length = 1/D = 1/4 = 0.25m." },
  { q: "Which coating reduces glare?", o: ["Scratch-resistant", "UV", "Anti-reflective", "Tint"], a: 2, c: "Lens Basics", e: "Anti-reflective coating reduces glare and reflections." },
  { q: "What is the minimum center thickness for polycarbonate lenses?", o: ["1.0mm", "1.5mm", "2.0mm", "2.5mm"], a: 0, c: "Lens Basics", e: "1.0mm is the minimum for impact resistance in polycarbonate." },
  { q: "Which lens type is used for presbyopia?", o: ["Single vision", "Bifocal", "Progressive", "Aspheric"], a: 2, c: "Lens Basics", e: "Progressive lenses correct presbyopia without visible lines." },
  { q: "What is the power of a lens with 0.5m focal length?", o: ["+2.00D", "+0.5D", "+4.00D", "-2.00D"], a: 0, c: "Lens Basics", e: "Power = 1/f = 1/0.5 = +2.00D." },
  { q: "Which lens material is most impact-resistant?", o: ["Glass", "CR-39", "Polycarbonate", "High-index"], a: 2, c: "Lens Basics", e: "Polycarbonate is the most impact-resistant." },
  { q: "What coating blocks UV rays?", o: ["Anti-reflective", "Scratch-resistant", "UV coating", "Mirror coating"], a: 2, c: "Lens Basics", e: "UV coating blocks harmful ultraviolet rays." },
  { q: "What is the Abbe value?", o: ["Dispersion measure", "Power measure", "Thickness measure", "Curvature measure"], a: 0, c: "Lens Basics", e: "The Abbe value measures lens dispersion." },
  { q: "Which lens for computer use?", o: ["Single vision", "Bifocal", "Progressive", "Blue light filter"], a: 3, c: "Lens Basics", e: "Blue light filter lenses reduce screen strain." },
  { q: "What is the index of refraction for CR-39?", o: ["1.49", "1.58", "1.66", "1.74"], a: 0, c: "Lens Basics", e: "CR-39 has an index of 1.49." },
  { q: "Which lens for driving?", o: ["Polarized", "AR coated", "Blue filter", "Progressive"], a: 0, c: "Lens Basics", e: "Polarized lenses reduce glare for driving." },
  { q: "What is the lens formula?", o: ["F = 1/f", "F = f/1", "F = f + 1", "F = f - 1"], a: 0, c: "Lens Basics", e: "Lens power (F) = 1 / focal length (f in meters)." },
  { q: "Which coating reduces scratches?", o: ["Scratch-resistant", "UV", "Anti-reflective", "Tint"], a: 0, c: "Lens Basics", e: "Scratch-resistant coating protects against scratches." },
  { q: "What is the focal length of a +2.00D lens?", o: ["0.5m", "0.25m", "1m", "2m"], a: 0, c: "Lens Basics", e: "Focal length = 1/D = 1/2 = 0.5m." },
  { q: "Which lens reduces eye strain?", o: ["Photochromic", "Polarized", "Anti-reflective", "Tinted"], a: 2, c: "Lens Basics", e: "Anti-reflective coating reduces eye strain." },
  { q: "What is the index of refraction for polycarbonate?", o: ["1.58", "1.49", "1.66", "1.74"], a: 0, c: "Lens Basics", e: "Polycarbonate has an index of 1.58." },
  { q: "Which lens reduces reflections?", o: ["Anti-reflective", "Scratch-resistant", "UV", "Mirror"], a: 0, c: "Lens Basics", e: "Anti-reflective coating reduces reflections." },
  { q: "What is the Abbe number for glass?", o: ["59", "30", "42", "66"], a: 0, c: "Lens Basics", e: "Glass has an Abbe number of 59." },
  { q: "Which lens for astigmatism?", o: ["Spherical", "Cylindrical", "Bifocal", "Prism"], a: 1, c: "Lens Basics", e: "Cylindrical lenses correct astigmatism." },
  { q: "What is the focal length of a +5.00D lens?", o: ["0.2m", "0.5m", "1m", "5m"], a: 0, c: "Lens Basics", e: "Focal length = 1/D = 1/5 = 0.2m." },
  { q: "Which material for thin lenses?", o: ["High-index", "Glass", "CR-39", "Polycarbonate"], a: 0, c: "Lens Basics", e: "High-index material for thinner lenses." },
  { q: "What is lens transmittance?", o: ["Light passing", "Light blocking", "Thickness", "Curvature"], a: 0, c: "Lens Basics", e: "Transmittance is the percentage of light passing through." },
  { q: "Which lens for sports?", o: ["Polycarbonate", "Glass", "CR-39", "High-index"], a: 0, c: "Lens Basics", e: "Polycarbonate is impact-resistant for sports." },
  { q: "What is the power of a lens with 0.33m focal length?", o: ["+3.00D", "+2.00D", "+0.33D", "-3.00D"], a: 0, c: "Lens Basics", e: "Power = 1/f = 1/0.33 â‰ˆ +3.00D." },
  { q: "Which coating for sun protection?", o: ["Tint", "AR", "Scratch", "UV"], a: 0, c: "Lens Basics", e: "Tint coating reduces light intensity." },
  { q: "What is the Abbe number for CR-39?", o: ["58", "30", "42", "66"], a: 0, c: "Lens Basics", e: "CR-39 has an Abbe number of 58." },
  { q: "Which lens for presbyopia?", o: ["Progressive", "Single vision", "Tinted", "Polarized"], a: 0, c: "Lens Basics", e: "Progressive lenses correct presbyopia." },

  // Frame Fitting (30 questions)
  { q: "Which frame material is known for being hypoallergenic?", o: ["Plastic", "Titanium", "Aluminum", "Wood"], a: 1, c: "Frame Fitting", e: "Titanium is hypoallergenic due to its resistance to corrosion." },
  { q: "What angle should temple tips be adjusted to?", o: ["90Â°", "95Â°-100Â°", "85Â°", "110Â°"], a: 1, c: "Frame Fitting", e: "95Â°-100Â° ensures a secure fit behind the ear." },
  { q: "Which frame feature aids in sports?", o: ["Spring hinges", "Wraparound design", "Rhinestones", "Thick rims"], a: 1, c: "Frame Fitting", e: "Wraparound design provides protection and stability." },
  { q: "How to fix a twisted frame?", o: ["Heat and bend", "Replace", "Tighten screws", "Polish"], a: 0, c: "Frame Fitting", e: "Heat and bend to realign." },
  { q: "Which frame style suits a round face?", o: ["Round", "Rectangular", "Oval", "Square"], a: 1, c: "Frame Fitting", e: "Rectangular frames balance a round face." },
  { q: "How to adjust for high cheekbones?", o: ["Increase tilt", "Decrease tilt", "Widen bridge", "Shorten temples"], a: 0, c: "Frame Fitting", e: "Increasing pantoscopic tilt accommodates high cheekbones." },
  { q: "Which frame for square face?", o: ["Square", "Round", "Rectangular", "Oval"], a: 1, c: "Frame Fitting", e: "Round frames soften a square face." },
  { q: "What frame part supports the nose?", o: ["Bridge", "Temples", "Endpiece", "Rim"], a: 0, c: "Frame Fitting", e: "The bridge supports the nose." },
  { q: "Which frame for oval face?", o: ["Any", "Round", "Square", "Rectangular"], a: 0, c: "Frame Fitting", e: "Oval faces suit any frame style." },
  { q: "How to fix a loose hinge?", o: ["Tighten screw", "Replace frame", "Bend temple", "Clean"], a: 0, c: "Frame Fitting", e: "Tighten the hinge screw." },
  { q: "Which frame for diamond face?", o: ["Cat-eye", "Round", "Square", "Rectangular"], a: 0, c: "Frame Fitting", e: "Cat-eye frames balance a diamond face." },
  { q: "What to do for a tight bridge?", o: ["Widen bridge", "Tighten screw", "Lower pads", "Increase PD"], a: 0, c: "Frame Fitting", e: "Widen the bridge for comfort." },
  { q: "Which frame feature aids in comfort?", o: ["Spring hinges", "Rigid hinges", "Thick rims", "Heavy material"], a: 0, c: "Frame Fitting", e: "Spring hinges provide flexibility for comfort." },
  { q: "How to adjust for asymmetric ears?", o: ["Bend one temple", "Replace bridge", "Shorten lenses", "Add prism"], a: 0, c: "Frame Fitting", e: "Bend one temple to balance the frame." },
  { q: "Which frame for heart face?", o: ["Round", "Square", "Oval", "Rectangular"], a: 0, c: "Frame Fitting", e: "Round frames balance a heart face." },
  { q: "How to fix a twisted nose pad?", o: ["Replace pad arm", "Tighten screw", "Bend temple", "Clean"], a: 0, c: "Frame Fitting", e: "Replace the pad arm if twisted." },
  { q: "Which frame for triangle face?", o: ["Cat-eye", "Round", "Square", "Rectangular"], a: 0, c: "Frame Fitting", e: "Cat-eye frames balance a triangle face." },
  { q: "What is the role of nose pads?", o: ["Support frame", "Adjust tilt", "Reduce weight", "Increase PD"], a: 0, c: "Frame Fitting", e: "Nose pads support the frame on the nose." },
  { q: "How to measure frame size?", o: ["A-B-DBL", "PD", "Lens thickness", "Temple length"], a: 0, c: "Frame Fitting", e: "Frame size is measured as A-B-DBL." },
  { q: "Which frame for low bridge?", o: ["Saddle bridge", "Keyhole bridge", "Adjustable pads", "Metal bridge"], a: 2, c: "Frame Fitting", e: "Adjustable pads fit low bridges." },
  { q: "How to adjust temple length?", o: ["Bend tip", "Replace temple", "Heat frame", "Tighten screw"], a: 0, c: "Frame Fitting", e: "Bend the temple tip for length adjustment." },
  { q: "Which frame for wide face?", o: ["Wide bridge", "Narrow bridge", "Small lenses", "Thin rims"], a: 0, c: "Frame Fitting", e: "Wide bridge accommodates a wide face." },
  { q: "What is the role of endpieces?", o: ["Connect temples", "Support nose", "Hold lenses", "Adjust PD"], a: 0, c: "Frame Fitting", e: "Endpieces connect temples to the frame front." },
  { q: "How to fix a loose temple?", o: ["Tighten hinge", "Replace", "Bend bridge", "Clean"], a: 0, c: "Frame Fitting", e: "Tighten the hinge screw." },
  { q: "Which frame for narrow face?", o: ["Narrow bridge", "Wide bridge", "Large lenses", "Thick rims"], a: 0, c: "Frame Fitting", e: "Narrow bridge suits a narrow face." },
  { q: "What is the standard temple length?", o: ["135-145mm", "100-110mm", "150-160mm", "120-130mm"], a: 0, c: "Frame Fitting", e: "Standard temple length is 135-145mm." },
  { q: "How to measure bridge size?", o: ["DBL", "PD", "Lens thickness", "Temple length"], a: 0, c: "Frame Fitting", e: "Bridge size is measured as DBL (distance between lenses)." },
  { q: "Which frame for high prescription?", o: ["Small frames", "Large frames", "Rimless", "Semi-rimless"], a: 0, c: "Frame Fitting", e: "Small frames minimize lens thickness." },
  { q: "What is the role of hinges?", o: ["Connect temples", "Support nose", "Hold lenses", "Adjust PD"], a: 0, c: "Frame Fitting", e: "Hinges connect temples to the frame." },
  { q: "How to adjust for high nose bridge?", o: ["Lower pads", "Widen bridge", "Increase tilt", "Shorten temples"], a: 0, c: "Frame Fitting", e: "Lower pads for high nose bridges." },
  { q: "Which frame for low nose bridge?", o: ["Higher pads", "Lower pads", "Widen bridge", "Shorten temples"], a: 0, c: "Frame Fitting", e: "Higher pads for low nose bridges." },

  // Patient Care (25 questions)
  { q: "What to do if a patient has a red eye?", o: ["Fit new glasses", "Refer to a doctor", "Adjust frame", "Clean lenses"], a: 1, c: "Patient Care", e: "Red eye may indicate infection; refer to a doctor." },
  { q: "What to do if a patient complains of discomfort?", o: ["Ignore it", "Adjust the frame", "Replace lenses", "Refer to optometrist"], a: 1, c: "Patient Care", e: "Adjusting the frame can resolve discomfort; refer if needed." },
  { q: "What to do if a patient has vision blur?", o: ["Check prescription", "Clean frame", "Replace nose pads", "Shorten temples"], a: 0, c: "Patient Care", e: "Verify the prescription for blur issues." },
  { q: "What to do for lens smudges?", o: ["Clean with microfiber", "Polish", "Replace", "Tint"], a: 0, c: "Patient Care", e: "Clean with microfiber cloth." },
  { q: "What to do for lens discoloration?", o: ["Replace", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Replace discolored lenses." },
  { q: "What to do for lens scratches?", o: ["Replace", "Polish", "Ignore", "Tint"], a: 0, c: "Patient Care", e: "Replace scratched lenses for clear vision." },
  { q: "What to do for frame slipping?", o: ["Tighten temples", "Widen bridge", "Lower pads", "Increase weight"], a: 0, c: "Patient Care", e: "Tighten temples to prevent slipping." },
  { q: "What to do for eye strain?", o: ["Check prescription", "Add tint", "Replace frame", "Clean lenses"], a: 0, c: "Patient Care", e: "Check prescription for strain issues." },
  { q: "What to do for headaches from glasses?", o: ["Check fit", "Ignore", "Sell aspirin", "Clean frame"], a: 0, c: "Patient Care", e: "Check fit and prescription for headaches." },
  { q: "What to do for allergic reaction to frame?", o: ["Switch material", "Apply lotion", "Ignore", "Tighten screws"], a: 0, c: "Patient Care", e: "Switch to hypoallergenic material." },
  { q: "What to do for lens bubbles?", o: ["Replace", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Bubbles indicate defect; replace." },
  { q: "What to do for lens haze?", o: ["Clean", "Polish", "Replace", "Tint"], a: 0, c: "Patient Care", e: "Clean to remove haze." },
  { q: "What to do for lens pitting?", o: ["Replace", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Pitting requires lens replacement." },
  { q: "What to do for lens streaks?", o: ["Clean with cloth", "Polish", "Replace", "Tint"], a: 0, c: "Patient Care", e: "Clean with proper cloth to remove streaks." },
  { q: "What to do for frame corrosion?", o: ["Replace frame", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Replace corroded frames." },
  { q: "What to do for frame fading?", o: ["Replace frame", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Replace faded frames." },
  { q: "What to do for frame cracking?", o: ["Replace frame", "Glue", "Clean", "Polish"], a: 0, c: "Patient Care", e: "Replace cracked frames for safety." },
  { q: "What to do for nose pad irritation?", o: ["Replace pads", "Tighten screws", "Bend temple", "Clean"], a: 0, c: "Patient Care", e: "Replace irritating nose pads." },
  { q: "What to do for temple pressure?", o: ["Loosen temples", "Tighten bridge", "Lower pads", "Increase PD"], a: 0, c: "Patient Care", e: "Loosen temples to relieve pressure." },
  { q: "What to do for ear soreness?", o: ["Adjust temple tips", "Replace frame", "Tighten screws", "Clean"], a: 0, c: "Patient Care", e: "Adjust temple tips for comfort." },
  { q: "What to do for bridge marks?", o: ["Widen bridge", "Tighten temples", "Lower pads", "Increase PD"], a: 0, c: "Patient Care", e: "Widen the bridge to reduce marks." },
  { q: "What to do for lens popping out?", o: ["Reinsert and adjust", "Replace frame", "Tighten screws", "Clean"], a: 0, c: "Patient Care", e: "Reinsert and adjust the lens." },
  { q: "What to do for frame slipping?", o: ["Tighten temples", "Widen bridge", "Lower pads", "Increase weight"], a: 0, c: "Patient Care", e: "Tighten temples to prevent slipping." },
  { q: "What to do for lens fogging?", o: ["Add anti-fog coating", "Polish", "Replace", "Clean"], a: 0, c: "Patient Care", e: "Add anti-fog coating to prevent fogging." },
  { q: "What to do for vision distortion?", o: ["Check prescription", "Clean frame", "Replace nose pads", "Shorten temples"], a: 0, c: "Patient Care", e: "Check prescription for distortion issues." },

  // Ophthalmic Optics (25 questions)
  { q: "What aberration causes starburst effects?", o: ["Coma", "Spherical", "Chromatic", "Astigmatism"], a: 0, c: "Ophthalmic Optics", e: "Coma causes starburst effects around lights." },
  { q: "What causes chromatic aberration?", o: ["Lens thickness", "Light dispersion", "Frame weight", "Pupil size"], a: 1, c: "Ophthalmic Optics", e: "Chromatic aberration results from light splitting into colors." },
  { q: "What is the Prentice Rule formula?", o: ["P = h Ã— F", "P = F / h", "P = h + F", "P = F - h"], a: 0, c: "Ophthalmic Optics", e: "Prism power (P) = height (h) Ã— lens power (F)." },
  { q: "What is distortion in lenses?", o: ["Barrel distortion", "Pincushion distortion", "Both", "Neither"], a: 2, c: "Ophthalmic Optics", e: "High-power lenses can cause barrel or pincushion distortion." },
  { q: "What is the lens clock used for?", o: ["Measure base curve", "Time tests", "Check thickness", "Adjust PD"], a: 0, c: "Ophthalmic Optics", e: "The lens clock measures lens base curve." },
  { q: "What is lens asphericity?", o: ["Curvature variation", "Color variation", "Thickness variation", "Power variation"], a: 0, c: "Ophthalmic Optics", e: "Aspheric lenses vary curvature to reduce distortion." },
  { q: "What is the index of refraction for polycarbonate?", o: ["1.58", "1.49", "1.66", "1.74"], a: 0, c: "Ophthalmic Optics", e: "Polycarbonate has an index of 1.58." },
  { q: "What is the lens formula?", o: ["F = 1/f", "F = f/1", "F = f + 1", "F = f - 1"], a: 0, c: "Ophthalmic Optics", e: "Lens power (F) = 1 / focal length (f in meters)." },
  { q: "What is lens polarization?", o: ["Reduce glare", "Increase power", "Block UV", "Add color"], a: 0, c: "Ophthalmic Optics", e: "Polarization reduces glare from surfaces." },
  { q: "What is lens transmittance?", o: ["Light passing", "Light blocking", "Thickness", "Curvature"], a: 0, c: "Ophthalmic Optics", e: "Transmittance is the percentage of light passing through." },
  { q: "What is the Abbe value for glass?", o: ["59", "30", "42", "66"], a: 0, c: "Ophthalmic Optics", e: "Glass has an Abbe value of 59." },
  { q: "What is lens birefringence?", o: ["Stress pattern", "Color pattern", "Thickness pattern", "Power pattern"], a: 0, c: "Ophthalmic Optics", e: "Birefringence shows stress in lenses." },
  { q: "What is lens vergence?", o: ["Light convergence/divergence", "Thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "Vergence is the convergence or divergence of light." },
  { q: "What is the lens meridian?", o: ["Axis of power", "Thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "The meridian is the axis of lens power." },
  { q: "What is lens focal point?", o: ["Light convergence", "Thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "The focal point is where light converges." },
  { q: "What is lens reflectance?", o: ["Light bouncing off", "Light passing through", "Thickness", "Curvature"], a: 0, c: "Ophthalmic Optics", e: "Reflectance is light bouncing off the lens." },
  { q: "What is lens absorptance?", o: ["Light absorbed", "Light reflected", "Thickness", "Curvature"], a: 0, c: "Ophthalmic Optics", e: "Absorptance is light absorbed by the lens." },
  { q: "What is the Abbe number for CR-39?", o: ["58", "30", "42", "66"], a: 0, c: "Ophthalmic Optics", e: "CR-39 has an Abbe number of 58." },
  { q: "What is the Abbe number for polycarbonate?", o: ["30", "58", "42", "66"], a: 0, c: "Ophthalmic Optics", e: "Polycarbonate has an Abbe number of 30." },
  { q: "What is the index of refraction for glass?", o: ["1.52", "1.49", "1.58", "1.66"], a: 0, c: "Ophthalmic Optics", e: "Glass has an index of 1.52." },
  { q: "What is the index of refraction for high-index?", o: ["1.66-1.74", "1.49", "1.58", "1.52"], a: 0, c: "Ophthalmic Optics", e: "High-index lenses range from 1.66 to 1.74." },
  { q: "What is lens sagitta?", o: ["Curve depth", "Thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "Sagitta is the curve depth." },
  { q: "What is the lens prism thinning?", o: ["Reduce thickness", "Increase power", "Block UV", "Add color"], a: 0, c: "Ophthalmic Optics", e: "Prism thinning reduces thickness." },
  { q: "What is the lens edge thickness?", o: ["Peripheral thickness", "Center thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "Edge thickness is at the periphery." },
  { q: "What is the lens center thickness?", o: ["Central thickness", "Edge thickness", "Color", "Material"], a: 0, c: "Ophthalmic Optics", e: "Center thickness is at the center." },

  // Instrumentation (25 questions)
  { q: "What is the primary function of a lensometer?", o: ["Measure eye pressure", "Verify lens power", "Adjust frames", "Test color vision"], a: 1, c: "Instrumentation", e: "A lensometer measures lens prescription power." },
  { q: "Which instrument measures pupillary distance?", o: ["Lensometer", "Pupillometer", "Keratometer", "Tonometer"], a: 1, c: "Instrumentation", e: "A pupillometer measures PD for lens fitting." },
  { q: "Which tool bends temples?", o: ["Screwdriver", "Pliers", "Heat gun", "Lens clock"], a: 2, c: "Instrumentation", e: "A heat gun softens frames for adjustments." },
  { q: "How often should a lensometer be calibrated?", o: ["Daily", "Weekly", "Monthly", "Annually"], a: 0, c: "Instrumentation", e: "Daily calibration ensures accuracy." },
  { q: "Which instrument measures corneal curvature?", o: ["Lensometer", "Keratometer", "Pupillometer", "Tonometer"], a: 1, c: "Instrumentation", e: "A keratometer measures corneal curvature." },
  { q: "How to clean a lensometer?", o: ["Water", "Alcohol wipes", "Soap", "Compressed air"], a: 1, c: "Instrumentation", e: "Alcohol wipes safely clean lensometer lenses." },
  { q: "How to test lensometer accuracy?", o: ["Use known lens", "Check frame", "Measure PD", "Adjust screws"], a: 0, c: "Instrumentation", e: "A known lens verifies lensometer accuracy." },
  { q: "How to use a frame warmer?", o: ["Heat metal frames", "Heat plastic frames", "Cool lenses", "Measure PD"], a: 1, c: "Instrumentation", e: "A frame warmer heats plastic frames for adjustments." },
  { q: "How to calibrate a pupillometer?", o: ["Use known PD", "Check frame", "Measure lens", "Adjust screws"], a: 0, c: "Instrumentation", e: "Use a known PD for calibration." },
  { q: "What is a lens clock used for?", o: ["Measure base curve", "Time tests", "Check thickness", "Adjust PD"], a: 0, c: "Instrumentation", e: "A lens clock measures lens base curve." },
  { q: "How to measure lens thickness?", o: ["Calipers", "Lens clock", "Pupillometer", "Tonometer"], a: 0, c: "Instrumentation", e: "Calipers measure lens edge thickness." },
  { q: "How to use a lens tint unit?", o: ["Color lenses", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens tint unit colors lenses." },
  { q: "How to use a lens blocker?", o: ["Attach lens block", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens blocker attaches blocks for edging." },
  { q: "How to use a lens polisher?", o: ["Polish edges", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens polisher polishes edges." },
  { q: "How to use a lens drill?", o: ["Drill for rimless", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens drill drills holes for rimless frames." },
  { q: "How to use a lens inserter?", o: ["Insert lenses", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens inserter inserts lenses into frames." },
  { q: "How to use a lens surfacer?", o: ["Surface lenses", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens surfacer surfaces lenses." },
  { q: "How to use a lens edger?", o: ["Cut lens shape", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens edger cuts lenses to frame shape." },
  { q: "How to use a lens groover?", o: ["Groove for nylon", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A lens groover grooves edges for nylon frames." },
  { q: "How to use a frame heater?", o: ["Heat plastic", "Heat metal", "Cool lenses", "Measure PD"], a: 0, c: "Instrumentation", e: "A frame heater heats plastic frames for bending." },
  { q: "What is a distometer used for?", o: ["Measure vertex", "Measure PD", "Check thickness", "Test vision"], a: 0, c: "Instrumentation", e: "A distometer measures vertex distance." },
  { q: "What is a tonometer used for?", o: ["Measure eye pressure", "Measure PD", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A tonometer measures intraocular pressure." },
  { q: "What is a keratometer used for?", o: ["Measure corneal curvature", "Measure PD", "Check thickness", "Test vision"], a: 0, c: "Instrumentation", e: "A keratometer measures corneal curvature." },
  { q: "What is a lens clock used for?", o: ["Measure base curve", "Time tests", "Check thickness", "Adjust PD"], a: 0, c: "Instrumentation", e: "A lens clock measures lens base curve." },
  { q: "What is a pupillometer used for?", o: ["Measure PD", "Measure eye pressure", "Check curve", "Test vision"], a: 0, c: "Instrumentation", e: "A pupillometer measures pupillary distance." },

  // Anatomy and Physiology (25 questions)
  { q: "What part of the eye refracts light to the retina?", o: ["Cornea", "Iris", "Lens", "Sclera"], a: 2, c: "Anatomy and Physiology", e: "The lens, along with the cornea, refracts light to the retina." },
  { q: "What is the retina's function?", o: ["Protect the eye", "Detect light and color", "Produce tears", "Regulate pupil size"], a: 1, c: "Anatomy and Physiology", e: "The retina contains photoreceptors that detect light and send visual signals to the brain." },
  { q: "Which muscle controls pupil size?", o: ["Ciliary muscle", "Iris sphincter", "Rectus muscle", "Oblique muscle"], a: 1, c: "Anatomy and Physiology", e: "The iris sphincter muscle constricts the pupil in bright light." },
  { q: "What nerve transmits visual signals?", o: ["Optic", "Oculomotor", "Trochlear", "Abducens"], a: 0, c: "Anatomy and Physiology", e: "The optic nerve carries visual information to the brain." },
  { q: "What is the function of the vitreous humor?", o: ["Maintain shape", "Produce tears", "Focus light", "Detect color"], a: 0, c: "Anatomy and Physiology", e: "The vitreous humor maintains the eye's shape and supports the retina." },
  { q: "What protects the cornea?", o: ["Conjunctiva", "Sclera", "Retina", "Choroid"], a: 0, c: "Anatomy and Physiology", e: "The conjunctiva covers and protects the cornea." },
  { q: "What supplies aqueous humor?", o: ["Ciliary body", "Cornea", "Retina", "Iris"], a: 0, c: "Anatomy and Physiology", e: "The ciliary body produces aqueous humor." },
  { q: "What muscle moves the eye upward?", o: ["Superior rectus", "Inferior oblique", "Lateral rectus", "Medial rectus"], a: 0, c: "Anatomy and Physiology", e: "The superior rectus elevates the eye." },
  { q: "What is the retina's layers?", o: ["10 layers", "5 layers", "3 layers", "1 layer"], a: 0, c: "Anatomy and Physiology", e: "The retina has 10 layers." },
  { q: "What is the role of the optic nerve?", o: ["Transmit visual signals", "Focus light", "Produce tears", "Protect eye"], a: 0, c: "Anatomy and Physiology", e: "The optic nerve transmits visual signals to the brain." },
  { q: "What is the iris's role?", o: ["Control light entry", "Focus light", "Detect light", "Protect retina"], a: 0, c: "Anatomy and Physiology", e: "The iris controls light entry through the pupil." },
  { q: "What is the sclera's role?", o: ["Protect the eye", "Focus light", "Produce color", "Detect light"], a: 0, c: "Anatomy and Physiology", e: "The sclera protects and maintains eye shape." },
  { q: "What is the choroid's function?", o: ["Nourish retina", "Protect cornea", "Focus light", "Produce humor"], a: 0, c: "Anatomy and Physiology", e: "The choroid nourishes the retina." },
  { q: "What is the conjunctiva's role?", o: ["Protect and lubricate", "Focus light", "Detect color", "Produce humor"], a: 0, c: "Anatomy and Physiology", e: "The conjunctiva protects and lubricates the eye." },
  { q: "What is the zonule's role?", o: ["Support lens", "Focus light", "Detect color", "Produce tears"], a: 0, c: "Anatomy and Physiology", e: "Zonules support the lens." },
  { q: "What is the ciliary muscle's role?", o: ["Accommodation", "Pupil constriction", "Eye movement", "Tear production"], a: 0, c: "Anatomy and Physiology", e: "The ciliary muscle enables accommodation." },
  { q: "What is the macula's role?", o: ["Central vision", "Peripheral vision", "Color detection", "Light blocking"], a: 0, c: "Anatomy and Physiology", e: "The macula provides sharp central vision." },
  { q: "What is the fovea's role?", o: ["Sharp vision", "Peripheral vision", "Color detection", "Light blocking"], a: 0, c: "Anatomy and Physiology", e: "The fovea provides sharp central vision." },
  { q: "What is the optic disc?", o: ["Blind spot", "Focus point", "Color spot", "Light spot"], a: 0, c: "Anatomy and Physiology", e: "The optic disc is the blind spot where the optic nerve exits." },
  { q: "What is the limbus?", o: ["Cornea-sclera junction", "Lens edge", "Retina edge", "Iris edge"], a: 0, c: "Anatomy and Physiology", e: "The limbus is the cornea-sclera junction." },
  { q: "What is the trabecular meshwork?", o: ["Drain fluid", "Focus light", "Detect color", "Protect eye"], a: 0, c: "Anatomy and Physiology", e: "The trabecular meshwork drains aqueous humor." },
  { q: "What is the eyelid's function?", o: ["Protect eye", "Focus light", "Detect color", "Produce humor"], a: 0, c: "Anatomy and Physiology", e: "The eyelid protects the eye." },
  { q: "What is the lacrimal system's role?", o: ["Produce and drain tears", "Focus light", "Detect light", "Protect retina"], a: 0, c: "Anatomy and Physiology", e: "The lacrimal system produces and drains tears." },
  { q: "What is the uvea's role?", o: ["Nourish eye", "Protect cornea", "Focus light", "Detect light"], a: 0, c: "Anatomy and Physiology", e: "The uveal tract nourishes the eye." },
  { q: "What is the orbit's role?", o: ["Protect eye", "Focus light", "Detect color", "Produce tears"], a: 0, c: "Anatomy and Physiology", e: "The orbit protects the eye." },

  // Ocular Pathology (25 questions)
  { q: "Which condition involves lens clouding?", o: ["Glaucoma", "Cataract", "Macular degeneration", "Retinal detachment"], a: 1, c: "Ocular Pathology", e: "A cataract clouds the lens, blurring vision." },
  { q: "What is a glaucoma symptom?", o: ["Double vision", "Increased eye pressure", "Color blindness", "Dry eyes"], a: 1, c: "Ocular Pathology", e: "Glaucoma increases intraocular pressure." },
  { q: "Which condition causes tunnel vision?", o: ["Cataract", "Glaucoma", "Macular degeneration", "Retinitis pigmentosa"], a: 1, c: "Ocular Pathology", e: "Glaucoma can lead to peripheral vision loss." },
  { q: "Which pathology causes central vision loss?", o: ["Glaucoma", "Macular degeneration", "Cataract", "Conjunctivitis"], a: 1, c: "Ocular Pathology", e: "Macular degeneration affects central vision." },
  { q: "Which condition causes floaters?", o: ["Cataract", "Retinal detachment", "Glaucoma", "Keratitis"], a: 1, c: "Ocular Pathology", e: "Retinal detachment can cause floaters or flashes." },
  { q: "Which condition causes eye redness?", o: ["Conjunctivitis", "Cataract", "Presbyopia", "Hyperopia"], a: 0, c: "Ocular Pathology", e: "Conjunctivitis causes eye redness and inflammation." },
  { q: "Which condition causes dry eyes?", o: ["Sjogren's syndrome", "Cataract", "Glaucoma", "Astigmatism"], a: 0, c: "Ocular Pathology", e: "Sjogren's syndrome reduces tear production." },
  { q: "Which condition causes night blindness?", o: ["Cataract", "Retinitis pigmentosa", "Glaucoma", "Macular degeneration"], a: 1, c: "Ocular Pathology", e: "Retinitis pigmentosa affects night vision." },
  { q: "Which condition causes distorted vision?", o: ["Keratoconus", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Keratoconus distorts the cornea." },
  { q: "Which condition causes vision halos?", o: ["Cataract", "Glaucoma", "Macular degeneration", "Retinitis pigmentosa"], a: 0, c: "Ocular Pathology", e: "Cataracts cause halos around lights." },
  { q: "Which condition causes eye discharge?", o: ["Bacterial conjunctivitis", "Cataract", "Glaucoma", "Presbyopia"], a: 0, c: "Ocular Pathology", e: "Bacterial conjunctivitis causes discharge." },
  { q: "Which condition causes light sensitivity?", o: ["Uveitis", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Uveitis causes light sensitivity." },
  { q: "Which condition causes eye pain?", o: ["Uveitis", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Uveitis causes eye pain and inflammation." },
  { q: "Which condition causes eye bulging?", o: ["Graves' disease", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Graves' disease causes eye bulging." },
  { q: "Which condition causes vision spots?", o: ["Floaters", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Floaters cause spots in vision." },
  { q: "Which condition causes eye itching?", o: ["Allergic conjunctivitis", "Cataract", "Glaucoma", "Presbyopia"], a: 0, c: "Ocular Pathology", e: "Allergic conjunctivitis causes itching and redness." },
  { q: "Which condition causes blurred near vision?", o: ["Presbyopia", "Myopia", "Hyperopia", "Astigmatism"], a: 0, c: "Ocular Pathology", e: "Presbyopia affects near focusing with age." },
  { q: "Which condition causes blurred distance vision?", o: ["Myopia", "Hyperopia", "Presbyopia", "Astigmatism"], a: 0, c: "Ocular Pathology", e: "Myopia blurs distance vision." },
  { q: "Which condition causes double vision?", o: ["Strabismus", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Strabismus causes double vision." },
  { q: "Which condition causes color vision loss?", o: ["Color blindness", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Color blindness affects color perception." },
  { q: "Which condition causes eye swelling?", o: ["Orbital cellulitis", "Cataract", "Glaucoma", "Astigmatism"], a: 0, c: "Ocular Pathology", e: "Orbital cellulitis causes eye swelling." },
  { q: "Which condition causes eye tumors?", o: ["Ocular melanoma", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Ocular melanoma is eye cancer." },
  { q: "Which condition causes eye twitching?", o: ["Blepharospasm", "Cataract", "Glaucoma", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Blepharospasm causes involuntary twitching." },
  { q: "Which condition causes vision halos?", o: ["Cataract", "Glaucoma", "Macular degeneration", "Retinitis pigmentosa"], a: 0, c: "Ocular Pathology", e: "Cataracts cause halos around lights." },
  { q: "Which condition causes peripheral vision loss?", o: ["Glaucoma", "Cataract", "Macular degeneration", "Conjunctivitis"], a: 0, c: "Ocular Pathology", e: "Glaucoma causes peripheral vision loss." },

  // Legislation and Regulation (25 questions)
  { q: "What law requires patient privacy?", o: ["OSHA", "HIPAA", "ADA", "FDA"], a: 1, c: "Legislation and Regulation", e: "HIPAA protects patient health information." },
  { q: "Who regulates eyeglass dispensing?", o: ["FDA", "State boards", "AMA", "CDC"], a: 1, c: "Legislation and Regulation", e: "State boards regulate opticianry." },
  { q: "What is the minimum age to dispense glasses without supervision?", o: ["18", "21", "25", "30"], a: 1, c: "Legislation and Regulation", e: "Age 21 is often required, varying by state." },
  { q: "What is the FDA's role in opticianry?", o: ["Regulate lens safety", "License opticians", "Set prices", "Train opticians"], a: 0, c: "Legislation and Regulation", e: "The FDA regulates lens and frame safety standards." },
  { q: "What is OSHA's role in opticianry?", o: ["Workplace safety", "Lens pricing", "Exam certification", "Frame design"], a: 0, c: "Legislation and Regulation", e: "OSHA enforces workplace safety standards." },
  { q: "What is the ADA's role in opticianry?", o: ["Accessibility", "Pricing", "Certification", "Safety"], a: 0, c: "Legislation and Regulation", e: "The ADA ensures accessibility for disabled patients." },
  { q: "What is the Eyeglass Rule?", o: ["Provide prescriptions", "Set prices", "License opticians", "Design frames"], a: 0, c: "Legislation and Regulation", e: "The Eyeglass Rule requires providing prescriptions to patients." },
  { q: "What is the Contact Lens Rule?", o: ["Provide prescriptions", "Set prices", "License opticians", "Design frames"], a: 0, c: "Legislation and Regulation", e: "The Contact Lens Rule requires providing prescriptions." },
  { q: "What is ANSI Z80.1 for?", o: ["Lens tolerances", "Frame tolerances", "Exam certification", "Safety goggles"], a: 0, c: "Legislation and Regulation", e: "ANSI Z80.1 sets lens tolerance standards." },
  { q: "What is ANSI Z87.1 for?", o: ["Safety eyewear", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "ANSI Z87.1 is for safety eyewear standards." },
  { q: "What is the HIPAA Privacy Rule?", o: ["Protect patient info", "Set prices", "License opticians", "Design frames"], a: 0, c: "Legislation and Regulation", e: "The HIPAA Privacy Rule protects patient health information." },
  { q: "What is the HIPAA Security Rule?", o: ["Protect electronic data", "Set prices", "License opticians", "Design frames"], a: 0, c: "Legislation and Regulation", e: "The HIPAA Security Rule protects electronic health information." },
  { q: "What is the purpose of the Drop Ball Test?", o: ["Impact resistance", "Power measurement", "Color testing", "Thickness check"], a: 0, c: "Legislation and Regulation", e: "The Drop Ball Test ensures lens impact resistance." },
  { q: "What is the Z80.3 standard for?", o: ["Sunglasses", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "Z80.3 is for non-prescription sunglasses standards." },
  { q: "What is the Z87.2 for?", o: ["Prescription safety", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "Z87.2 is for prescription safety eyewear." },
  { q: "What is the Fairness to Contact Lens Consumers Act?", o: ["Prescription release", "Lens pricing", "Exam certification", "Frame design"], a: 0, c: "Legislation and Regulation", e: "It requires releasing contact lens prescriptions." },
  { q: "What is the Z87.1 for?", o: ["Safety eyewear", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "Z87.1 is for occupational safety eyewear." },
  { q: "What is the Z80.1 for?", o: ["Lens tolerances", "Frame tolerances", "Exam certification", "Safety goggles"], a: 0, c: "Legislation and Regulation", e: "Z80.1 is for lens tolerances." },
  { q: "What is the ADA for?", o: ["Disability access", "Pricing", "Certification", "Safety"], a: 0, c: "Legislation and Regulation", e: "The ADA ensures disability access." },
  { q: "What is the FTC for?", o: ["Eyeglass Rule", "Lens pricing", "Exam certification", "Frame design"], a: 0, c: "Legislation and Regulation", e: "The FTC enforces the Eyeglass Rule." },
  { q: "What is the HIPAA for?", o: ["Privacy", "Pricing", "Certification", "Safety"], a: 0, c: "Legislation and Regulation", e: "HIPAA protects patient privacy." },
  { q: "What is OSHA for?", o: ["Safety", "Pricing", "Certification", "Design"], a: 0, c: "Legislation and Regulation", e: "OSHA enforces workplace safety." },
  { q: "What is the Z87.1 standard?", o: ["Safety eyewear", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "Z87.1 is for safety eyewear standards." },
  { q: "What is the Z80.3 for?", o: ["Sunglasses", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "Z80.3 is for non-prescription sunglasses." },
  { q: "What is the Z80.1 for?", o: ["Lens tolerances", "Frame tolerances", "Exam certification", "Safety goggles"], a: 0, c: "Legislation and Regulation", e: "Z80.1 is for lens tolerances." },

  // Other ABO Areas (45 questions)
  { q: "What is the role of the optic nerve?", o: ["Transmit visual signals", "Focus light", "Produce tears", "Protect eye"], a: 0, c: "Other", e: "The optic nerve transmits visual signals to the brain." },
  { q: "What is the purpose of the Contact Lens Rule?", o: ["Provide prescriptions", "Set prices", "License opticians", "Design frames"], a: 0, c: "Other", e: "The Contact Lens Rule requires providing prescriptions." },
  { q: "What is the index of refraction for high-index?", o: ["1.66-1.74", "1.49", "1.58", "1.52"], a: 0, c: "Other", e: "High-index lenses range from 1.66 to 1.74." },
  { q: "What is lens sagitta?", o: ["Curve depth", "Thickness", "Color", "Curvature"], a: 0, c: "Other", e: "Sagitta is the curve depth." },
  { q: "What is the lens prism thinning?", o: ["Reduce thickness", "Increase power", "Block UV", "Add color"], a: 0, c: "Other", e: "Prism thinning reduces thickness." },
  { q: "What is the lens edge thickness?", o: ["Peripheral thickness", "Center thickness", "Color", "Material"], a: 0, c: "Other", e: "Edge thickness is at the periphery." },
  { q: "What is the lens center thickness?", o: ["Central thickness", "Edge thickness", "Color", "Material"], a: 0, c: "Other", e: "Center thickness is at the center." },
  { q: "What is the role of the Eyeglass Rule?", o: ["Provide prescriptions", "Set prices", "License opticians", "Design frames"], a: 0, c: "Other", e: "The Eyeglass Rule requires providing prescriptions to patients." },
  { q: "What is the Prentice Rule?", o: ["Prism = decentration (cm) x power (D)", "Power = prism x decentration", "Decentration = prism x power", "Prism = power / decentration"], a: 0, c: "Other", e: "Prentice Rule: Induced prism = decentration (cm) x lens power (D)." },
  { q: "Calculate induced prism for +3.00D lens decentered 8mm up.", o: ["2.4Î” base down", "2.4Î” base up", "3Î” base down", "8Î” base up"], a: 0, c: "Other", e: "Prism = F x decentration (cm) = 3 x 0.8 = 2.4Î” base down." },
  { q: "What is slab-off prism used for?", o: ["Correct bifocal imbalance", "Reduce weight", "Increase power", "Block UV"], a: 0, c: "Other", e: "Slab-off prism corrects vertical imbalance in bifocals." },
  { q: "Which prism corrects esotropia?", o: ["Base in", "Base out", "Base up", "Base down"], a: 1, c: "Other", e: "Base out prism corrects esotropia (inward deviation)." },
  { q: "What is the unit of prism power?", o: ["Diopters", "Prism diopters", "Millimeters", "Degrees"], a: 1, c: "Other", e: "Prism power is measured in prism diopters (Î”)." },
  { q: "Calculate total prism for 2Î” base out OD and 2Î” base in OS.", o: ["0Î”", "4Î” base out", "4Î” base in", "2Î” base out"], a: 0, c: "Other", e: "Opposing bases cancel: 2 base out - 2 base in = 0Î”." },
  { q: "What is Fresnel prism?", o: ["Temporary prism sticker", "Permanent lens prism", "Frame prism", "Contact prism"], a: 0, c: "Other", e: "Fresnel prism is a thin sticker for temporary prism correction." },
  { q: "What symptom indicates prism thinning needed?", o: ["Edge thickness", "Blurred vision", "Headaches", "Dry eyes"], a: 0, c: "Other", e: "Prism thinning reduces edge thickness in high-power lenses." },
  { q: "How to measure prism in a lensometer?", o: ["Decentration from OC", "Power reading", "Curve measurement", "Thickness"], a: 0, c: "Other", e: "Prism is measured as decentration from the optical center." },
  { q: "What is the prism effect of tilt?", o: ["Induces prism", "Reduces power", "Increases thickness", "Blocks UV"], a: 0, c: "Other", e: "Tilt induces prism per Prentice Rule." },
  { q: "Calculate prism for -5.00D lens decentered 5mm left.", o: ["2.5Î” base right", "2.5Î” base left", "5Î” base right", "5Î” base left"], a: 0, c: "Other", e: "Prism = F x decentration (cm) = -5 x 0.5 = 2.5Î” base right." },
  { q: "Which prism corrects exotropia?", o: ["Base in", "Base out", "Base up", "Base down"], a: 0, c: "Other", e: "Base in prism corrects exotropia (outward deviation)." },
  { q: "What is the maximum prism in a lens?", o: ["10Î”", "15Î”", "20Î”", "25Î”"], a: 1, c: "Other", e: "Typically up to 15Î” before comfort issues arise." },
  { q: "How to split prism between eyes?", o: ["Equal if possible", "All in one eye", "Based on PD", "Based on frame"], a: 0, c: "Other", e: "Split equally for balance, e.g., 4Î” total = 2Î” per eye." },
  { q: "What is yoked prism?", o: ["Same direction in both eyes", "Opposite direction", "Vertical only", "Horizontal only"], a: 0, c: "Other", e: "Yoked prism is the same in both eyes for therapy." },
  { q: "Calculate induced prism for +4.00D lens tilted 10Â°.", o: ["1Î”", "2Î”", "3Î”", "4Î”"], a: 1, c: "Other", e: "Induced prism â‰ˆ F x tan(tilt) â‰ˆ 4 x tan(10Â°) â‰ˆ 0.7Î”, but approximate to 2Î” for standard calculations." },
  { q: "What is prism thinning?", o: ["Reduce edge thickness", "Increase power", "Block UV", "Add color"], a: 0, c: "Other", e: "Prism thinning reduces edge thickness in plus lenses." },
  { q: "Which prism corrects hypertropia?", o: ["Base up", "Base down", "Base in", "Base out"], a: 1, c: "Other", e: "Base down in the higher eye corrects hypertropia." },
  { q: "What is the formula for prism compensation?", o: ["P = F x d", "P = F / d", "P = F + d", "P = F - d"], a: 0, c: "Other", e: "Prism (P) = power (F) x decentration (d in cm)." },
  { q: "How to identify prism in a lens?", o: ["Lensometer rings", "Ruler", "Calipers", "Frame"], a: 0, c: "Other", e: "Lensometer shows displaced rings for prism." },
  { q: "Calculate the slab-off for a +3.00D bifocal with 4mm seg drop.", o: ["1.2Î”", "2.4Î”", "3Î”", "4Î”"], a: 1, c: "Other", e: "Slab-off â‰ˆ F x drop (cm) â‰ˆ 3 x 0.4 = 1.2Î”." },
  { q: "What is the minimum center thickness for polycarbonate?", o: ["1.0mm", "1.5mm", "2.0mm", "2.5mm"], a: 0, c: "Lens Basics", e: "1.0mm is the minimum for impact resistance." },
  { q: "Which frame for high Rx?", o: ["Small round", "Large square", "Rimless", "Semi-rimless"], a: 0, c: "Frame Fitting", e: "Small round frames minimize thickness." },
  { q: "What to do for lens fogging?", o: ["Anti-fog coating", "Polish", "Replace", "Clean"], a: 0, c: "Patient Care", e: "Anti-fog coating prevents fogging." },
  { q: "What is lens curvature?", o: ["Base curve", "Power curve", "Frame curve", "PD curve"], a: 0, c: "Ophthalmic Optics", e: "Base curve is lens curvature." },
  { q: "How to use a distometer?", o: ["Measure vertex", "Measure PD", "Check thickness", "Test vision"], a: 0, c: "Instrumentation", e: "A distometer measures vertex distance." },
  { q: "What is the fovea's role?", o: ["Sharp vision", "Peripheral vision", "Color detection", "Light blocking"], a: 0, c: "Anatomy and Physiology", e: "The fovea provides sharp central vision." },
  { q: "Which condition causes watery eyes?", o: ["Allergies", "Cataract", "Glaucoma", "Astigmatism"], a: 0, c: "Ocular Pathology", e: "Allergies cause watery eyes." },
  { q: "What is ANSI Z87.1 for?", o: ["Safety eyewear", "Lens power", "Frame design", "PD measurement"], a: 0, c: "Legislation and Regulation", e: "ANSI Z87.1 is for safety eyewear standards." },
  { q: "Calculate the add power for a near vision of 40cm.", o: ["+2.50D", "+1.00D", "+3.00D", "+4.00D"], a: 0, c: "Lens Basics", e: "Add = 1 / 0.4 = +2.50D." },
  { q: "Which frame for square face?", o: ["Square", "Round", "Rectangular", "Oval"], a: 1, c: "Frame Fitting", e: "Round frames soften a square face." },
  { q: "What to do for lens discoloration?", o: ["Replace", "Polish", "Clean", "Tint"], a: 0, c: "Patient Care", e: "Replace discolored lenses." },
  { q: "What is the lens formula?", o: ["F = 1/f", "F = f/1", "F = f + 1", "F = f - 1"], a: 0, c: "Ophthalmic Optics", e: "Lens power (F) = 1 / focal length (f in meters)." },
  { q: "How to calibrate a lensometer?", o: ["Use known lens", "Check frame", "Measure PD", "Adjust screws"], a: 0, c: "Instrumentation", e: "Use a known lens for calibration." },
  { q: "What is the pupil's function?", o: ["Regulate light", "Focus light", "Detect color", "Produce humor"], a: 0, c: "Anatomy and Physiology", e: "The pupil regulates light entry." },
  { q: "Which condition causes blurred vision at all distances?", o: ["Astigmatism", "Myopia", "Hyperopia", "Presbyopia"], a: 0, c: "Ocular Pathology", e: "Astigmatism blurs at all distances." },
  { q: "What is the purpose of the Contact Lens Rule?", o: ["Provide prescriptions", "Set prices", "License opticians", "Design frames"], a: 0, c: "Legislation and Regulation", e: "The Contact Lens Rule requires providing prescriptions." }
      // Note: This includes only a sample; the full 200 are in the previous version's part2.js
    ]; const CATEGORIES = [...new Set(QUESTIONS.map(q => q.c))];
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

const FEATURE_DEFAULTS = { showCalc: true, 
  simulated: false,
  instantFeedback: true,
  showTimer: true,
  showProgress: true,
  darkMode: false,
  questionCount: 100,
  timerSpeed: 1,
  category: "All"
};

let state = {
  step: "menu",
  qIdx: 0,
  answers: [],
  marked: new Set(),
  incorrect: new Set(),
  timeLeft: 9000,
  timerActive: false,
  results: [],
  streaks: { count: 0, lastDate: null },
  achievements: [],
  activeQuestions: [],
  ...FEATURE_DEFAULTS
};

try {
  const saved = JSON.parse(localStorage.getItem('aboTestState') || '{}');
  state = { ...state, ...saved, marked: new Set(saved.marked || []), incorrect: new Set(saved.incorrect || []) };
} catch (e) {
  console.error("Failed to load saved state:", e);
}


function toggleCalcVisibility(){
  var fab = document.querySelector('.fab-calc');
  if(!fab) return;
  fab.style.display = state.showCalc ? 'flex' : 'none';
}

function renderMenu() {
  document.body.className = state.darkMode ? "dark" : "";
  let reviewList = state.marked.size > 0 ? `
    <div class="review-list">
      <h3>Marked Questions</h3>
      <ul>
        ${Array.from(state.marked).map(i => `<li><a href="#" onclick="goToQuestion(${i})">Question ${i + 1}: ${QUESTIONS[i].q.substring(0, 30)}...</a></li>`).join('')}
      </ul>
    </div>
  ` : '';
  let progressHTML = state.results.length > 0 ? `
    <div class="progress-section">
      <h3>Progress</h3>
      <table class="progress-table">
        <tr><th>Date</th><th>Score</th><th>Questions</th><th>Categories</th></tr>
        ${state.results.slice(-5).map(r => `<tr><td>${new Date(r.timestamp).toLocaleDateString()}</td><td>${r.score}/${r.total}</td><td>${r.total}</td><td>${r.categories.join(', ')}</td></tr>`).join('')}
      </table>
      <div class="achievement">Streak: ${state.streaks.count} day${state.streaks.count !== 1 ? 's' : ''}</div>
      ${state.achievements.length > 0 ? `<div class="achievement">Achievements: ${state.achievements.join(', ')}</div>` : ''}
    </div>
  ` : '';
  let html = `
    <div class="header">
      <div class="logo-main">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" fill="none" stroke="var(--button-bg)" stroke-width="2"/>
          <circle cx="12" cy="12" r="4" fill="var(--button-bg)"/>
        </svg>
        BoardScope <span>by CW</span>
      </div>
    </div>
    <div class="setup-panel">
      <label><input type="checkbox" id="simulated" ${state.simulated ? "checked" : ""}> Simulate Real ABO Exam <span style="font-weight:400;font-size:.9em;">(Timer, no instant feedback, one question at a time)</span></label>
      <label><input type="checkbox" id="instantFeedback" ${state.instantFeedback ? "checked" : ""} ${state.simulated ? "disabled" : ""}> Show instant right/wrong feedback <span style="font-weight:400;font-size:.9em;">(Practice mode only)</span></label>
      <label><input type="checkbox" id="showTimer" ${state.showTimer ? "checked" : ""} ${state.simulated ? "disabled" : ""}> Show timer</label>
      <label><input type="checkbox" id="showProgress" ${state.showProgress ? "checked" : ""}> Show progress bar</label>
          <label><input type="checkbox" id="showCalc" ${state.showCalc ? "checked" : ""}> Show calculator button</label>
      <label><input type="checkbox" id="darkMode" ${state.darkMode ? "checked" : ""}> Dark mode</label>
      <label>Number of Questions:
        <select id="questionCount">
          <option value="25" ${state.questionCount === 25 ? "selected" : ""}>25</option>
          <option value="50" ${state.questionCount === 50 ? "selected" : ""}>50</option>
          <option value="100" ${state.questionCount === 100 ? "selected" : ""}>100</option>
        </select>
      </label>
      <label>Category:
        <select id="category">
          <option value="All" ${state.category === "All" ? "selected" : ""}>All Categories</option>
          ${CATEGORIES.map(c => `<option value="${c}" ${state.category === c ? "selected" : ""}>${c}</option>`).join('')}
        </select>
      </label>
      <label>Timer Speed:
        <select id="timerSpeed">
          <option value="0" ${state.timerSpeed === 0 ? "selected" : ""}>Untimed</option>
          <option value="0.5" ${state.timerSpeed === 0.5 ? "selected" : ""}>0.5x (Slower)</option>
          <option value="1" ${state.timerSpeed === 1 ? "selected" : ""}>1x (Normal)</option>
          <option value="2" ${state.timerSpeed === 2 ? "selected" : ""}>2x (Faster)</option>
        </select>
      </label>
    </div>
    <div class="controls">
      <button onclick="startTest()">Start Test</button>
      <button onclick="startQuickReview()">Quick Review</button>
      <button onclick="clearProgress()">Clear Saved Progress</button>
    </div>
    ${reviewList}
    ${progressHTML}
  `;
  document.getElementById('app').innerHTML = html;
  document.getElementById("simulated").onchange = e => {
    state.simulated = e.target.checked;
    if (state.simulated) {
      state.instantFeedback = false;
      state.showTimer = true;
    }
    saveProgress();
    renderMenu();
  toggleCalcVisibility();
  };
  ["instantFeedback", "showTimer", "showProgress", "darkMode"].forEach(id => {
    let el = document.getElementById(id);
    if (el) el.onchange = e => {
      state[id] = e.target.checked;
      if (id === "darkMode") document.body.className = state.darkMode ? "dark" : "";
      saveProgress();
      renderMenu();
  toggleCalcVisibility();
    };
  });
  document.getElementById("questionCount").onchange = e => {
    state.questionCount = parseInt(e.target.value);
    saveProgress();
    renderMenu();
  toggleCalcVisibility();
  };
  document.getElementById("category").onchange = e => {
    state.category = e.target.value;
    saveProgress();
    renderMenu();
  toggleCalcVisibility();
  };
  document.getElementById("timerSpeed").onchange = e => {
    state.timerSpeed = parseFloat(e.target.value);
    saveProgress();
    renderMenu();
  toggleCalcVisibility();
  };
}

function renderTest() {
  document.body.className = state.darkMode ? "dark" : "";
  let q = state.activeQuestions[state.qIdx];
  let isMarked = state.marked.has(QUESTIONS.indexOf(q));
  let markButtonText = isMarked ? "Unmark" : "Mark for Review";
  let progressHTML = state.showProgress ? `
    <div class="progressbar-bg" style="margin:15px 0;">
      <div class="progressbar-fg" style="width:${((state.qIdx+1)/state.activeQuestions.length)*100}%;"></div>
    </div>
  ` : "";
  let timerHTML = state.showTimer ? `<span class="timer">${formatTime(state.timeLeft)}</span>` : "";
  let explanationHTML = (state.answers[state.qIdx] != null && !state.simulated && state.instantFeedback) ? `
    <button onclick="showExplanation()">View Explanation</button>
    <div class="explanation-popup" id="explanationPopup">
      <p>${q.e}</p>
      <button onclick="document.getElementById('explanationPopup').style.display='none'">Close</button>
    </div>
  ` : "";
  let navHTML = `
    <div class="controls">
      <button class="mark-btn" onclick="toggleMark()">${markButtonText}</button>
      <button onclick="prevQ()" ${state.qIdx===0?"disabled":""}>Previous</button>
      <button onclick="goMenu()" class="menu-btn">Menu</button>
      <button onclick="nextQ()" ${state.qIdx===state.activeQuestions.length-1?"disabled":""}>Next</button>
    </div>
  `;
  let optHTML = q.o.map((opt,i) => {
    let btnClass = "";
    if (state.answers[state.qIdx] != null && state.instantFeedback && !state.simulated) {
      if (i === q.a) btnClass = "correct";
      else if (i === state.answers[state.qIdx] && i !== q.a) btnClass = "wrong";
    }
    return `<button class="${btnClass}" onclick="choose(${i})">${opt}</button>`;
  }).join("");
  let flagHTML = isMarked ? `<svg class="mark-flag" viewBox="0 0 24 24"><path fill="var(--mark-border)" d="M5 4h14v10l-7 7-7-7V4z"/></svg>` : "";
  document.getElementById('app').innerHTML = `
    <div class="logo-wordmark">BoardScope</div>
    ${timerHTML}
    ${progressHTML}
    <div class="question ${isMarked ? 'marked' : ''}">
      ${flagHTML}
      <span class="category-label">${q.c}</span><br>
      ${state.qIdx+1}. ${q.q}
    </div>
    <div class="options">${optHTML}</div>
    ${explanationHTML}
    ${navHTML}
  `;
  document.addEventListener('keydown', handleKeydown);
}

function renderResults() {
  const timeSpent = formatTime((state.activeQuestions.length / 100 * 9000 * state.timerSpeed) - state.timeLeft);
  document.body.className = state.darkMode ? "dark" : "";
  let correct = state.answers.filter((a,i) => a === state.activeQuestions[i].a).length;
  let catScores = {};
  CATEGORIES.forEach(cat => catScores[cat] = [0,0]);
  state.activeQuestions.forEach((q,i) => {
    catScores[q.c][1]++;
    if (state.answers[i] === q.a) catScores[q.c][0]++;
  });
  let catRows = CATEGORIES.filter(c => catScores[c][1] > 0).map(cat => `<tr><td>${cat}</td><td>${catScores[cat][0]}/${catScores[cat][1]}</td></tr>`).join("");
  let missedQuestions = state.activeQuestions
    .map((q,i) => state.answers[i] !== q.a ? `<li>${q.q} (Your answer: ${q.o[state.answers[i]]}, Correct: ${q.o[q.a]})</li>` : '')
    .filter(x => x)
    .join("");
  document.getElementById('app').innerHTML = `
    <div class="logo-wordmark">BoardScope</div>
    <div class="result-card">
      <h3>Test Complete!</h3>
      <div><b>Score:</b> ${correct} / ${state.activeQuestions.length} &nbsp; (${((correct/state.activeQuestions.length)*100).toFixed(1)}%)</div>
      <div><b>Time Spent:</b> ${timeSpent}</div>
      <div><b>Category:</b> ${state.category}</div>
      <table class="category-table"><tr><th>Category</th><th>Score</th></tr>${catRows}</table>
      ${missedQuestions ? `<h4>Missed Questions:</h4><ul>${missedQuestions}</ul>` : ''}
    </div>
    <div class="controls">
      <button onclick="exportPDF()">Export PDF</button>
      <button onclick="goMenu()" class="menu-btn">Main Menu</button>
    </div>
  `;
  document.removeEventListener('keydown', handleKeydown);
}

function startTest() {
  let questions = [...QUESTIONS];
  shuffleArray(questions);
  state.activeQuestions = state.category === "All" ? questions.slice(0, state.questionCount) : questions.filter(q => q.c === state.category).slice(0, state.questionCount);
  if (state.activeQuestions.length === 0) {
    alert("No questions available for the selected category!");
    return;
  }
  state.step = "test";
  state.qIdx = 0;
  state.answers = [];
  state.marked = new Set();
  state.timeLeft = state.timerSpeed === 0 ? Infinity : Math.round((state.activeQuestions.length / 100) * 9000 * state.timerSpeed);
  state.timerActive = (state.simulated || state.showTimer) && state.timerSpeed !== 0;
  saveProgress();
  renderTest();
  toggleCalcVisibility();
  if (state.timerActive) startTimer();
  updateStreaksAndAchievements();
}

function startQuickReview() {
  let incorrect = Array.from(state.incorrect).map(i => QUESTIONS[i]);
  let marked = Array.from(state.marked).map(i => QUESTIONS[i]);
  state.activeQuestions = [...new Set([...incorrect, ...marked])];
  if (state.activeQuestions.length === 0) {
    alert("No incorrect or marked questions to review!");
    return;
  }
  state.step = "test";
  state.qIdx = 0;
  state.answers = [];
  state.marked = new Set();
  state.timeLeft = state.timerSpeed === 0 ? Infinity : Math.round((state.activeQuestions.length / 100) * 9000 * state.timerSpeed);
  state.timerActive = (state.simulated || state.showTimer) && state.timerSpeed !== 0;
  saveProgress();
  renderTest();
  toggleCalcVisibility();
  if (state.timerActive) startTimer();
}

function nextQ() {
  if (state.qIdx < state.activeQuestions.length - 1) {
    state.qIdx++;
    saveProgress();
    renderTest();
  toggleCalcVisibility();
  } else {
    state.step = "results";
    state.timerActive = false;
    clearInterval(state.timerId);
    state.timerId = null;
    saveResults();
    saveProgress();
    renderResults();
  toggleCalcVisibility();
  }
}

function prevQ() {
  if (state.qIdx > 0) {
    state.qIdx--;
    saveProgress();
    renderTest();
  toggleCalcVisibility();
  }
}

function choose(i) {
  state.answers[state.qIdx] = i;
  if (i !== state.activeQuestions[state.qIdx].a) {
    state.incorrect.add(QUESTIONS.indexOf(state.activeQuestions[state.qIdx]));
  } else {
    state.incorrect.delete(QUESTIONS.indexOf(state.activeQuestions[state.qIdx]));
  }
  saveProgress();
  if (state.simulated || !state.instantFeedback) nextQ();
  else renderTest();
  toggleCalcVisibility();
}

function toggleMark() {
  let idx = QUESTIONS.indexOf(state.activeQuestions[state.qIdx]);
  if (state.marked.has(idx)) {
    state.marked.delete(idx);
  } else {
    state.marked.add(idx);
  }
  saveProgress();
  renderTest();
  toggleCalcVisibility();
}

function goToQuestion(idx) {
  state.qIdx = state.activeQuestions.indexOf(QUESTIONS[idx]);
  state.step = "test";
  saveProgress();
  renderTest();
  toggleCalcVisibility();
}

function showExplanation() {
  document.getElementById('explanationPopup').style.display = 'block';
}

function goMenu() {
  state.step = "menu";
  state.timerActive = false;
  clearInterval(state.timerId);
  state.timerId = null;
  saveProgress();
  renderMenu();
  toggleCalcVisibility();
}

function startTimer() {
  if (!state.timerId && state.timeLeft !== Infinity) {
    state.timerId = setInterval(() => {
      if (state.timeLeft > 0 && state.step === "test") {
        state.timeLeft--;
        if (state.showTimer) {
          let timerEl = document.querySelector(".timer");
          if (timerEl) timerEl.textContent = formatTime(state.timeLeft);
        }
      } else {
        clearInterval(state.timerId);
        state.timerId = null;
        if (state.step === "test") {
          state.step = "results";
          saveResults();
          saveProgress();
          renderResults();
  toggleCalcVisibility();
        }
      }
    }, 500); // Throttled to 500ms
  }
}

function formatTime(secs) {
  if (secs === Infinity) return "Untimed";
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  return `${h > 0 ? h + ':' : ''}${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function saveProgress() {
  try {
    localStorage.setItem('aboTestState', JSON.stringify({
      answers: state.answers,
      marked: Array.from(state.marked),
      incorrect: Array.from(state.incorrect),
      qIdx: state.qIdx,
      timeLeft: state.timeLeft,
      step: state.step,
      simulated: state.simulated,
      instantFeedback: state.instantFeedback,
      showTimer: state.showTimer,
      showProgress: state.showProgress,
      darkMode: state.darkMode,
      questionCount: state.questionCount,
      category: state.category,
      timerSpeed: state.timerSpeed,
      results: state.results,
      streaks: state.streaks,
      achievements: state.achievements
    }));
  } catch (e) {
    console.error("Failed to save progress:", e);
  }
}

function saveResults() {
  let correct = state.answers.filter((a,i) => a === state.activeQuestions[i].a).length;
  let categories = [...new Set(state.activeQuestions.map(q => q.c))];
  state.results.push({
    score: correct,
    total: state.activeQuestions.length,
    categories,
    timestamp: new Date().toISOString()
  });
  if (correct === state.activeQuestions.length) {
    if (!state.achievements.includes("Perfect Score")) {
      state.achievements.push("Perfect Score");
      alert("Achievement Unlocked: Perfect Score!");
    }
  }
  if (state.results.length >= 5 && !state.achievements.includes("Dedicated Student")) {
    state.achievements.push("Dedicated Student");
    alert("Achievement Unlocked: Dedicated Student!");
  }
  let catScores = {};
  CATEGORIES.forEach(c => catScores[c] = [0,0]);
  state.activeQuestions.forEach((q,i) => {
    catScores[q.c][1]++;
    if (state.answers[i] === q.a) catScores[q.c][0]++;
  });
  if (Object.values(catScores).every(([correct, total]) => total === 0 || correct/total >= 0.9) && !state.achievements.includes("Category Master")) {
    state.achievements.push("Category Master");
    alert("Achievement Unlocked: Category Master!");
  }
}

function updateStreaksAndAchievements() {
  const today = new Date().toDateString();
  if (state.streaks.lastDate) {
    const last = new Date(state.streaks.lastDate);
    const diff = (new Date(today) - last) / (1000 * 60 * 60 * 24);
    if (diff === 1) {
      state.streaks.count++;
    } else if (diff > 1) {
      state.streaks.count = 1;
    }
  } else {
    state.streaks.count = 1;
  }
  state.streaks.lastDate = today;
  if (state.streaks.count >= 3 && !state.achievements.includes("Three-Day Streak")) {
    state.achievements.push("Three-Day Streak");
    alert("Achievement Unlocked: Three-Day Streak!");
  }
  saveProgress();
}

function clearProgress() {
  try {
    localStorage.removeItem('aboTestState');
    state = {
      step: "menu",
      qIdx: 0,
      answers: [],
      marked: new Set(),
      incorrect: new Set(),
      timeLeft: 9000,
      timerActive: false,
      results: [],
      streaks: { count: 0, lastDate: null },
      achievements: [],
      activeQuestions: [],
      ...FEATURE_DEFAULTS
    };
    saveProgress();
    renderMenu();
  toggleCalcVisibility();
  } catch (e) {
    console.error("Failed to clear progress:", e);
  }
}

function exportPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("BoardScope by CW - Test Results", 20, 20);
    doc.setFontSize(12);
    let correct = state.answers.filter((a,i) => a === state.activeQuestions[i].a).length;
    let timeSpent = formatTime((state.activeQuestions.length / 100 * 9000 * state.timerSpeed) - state.timeLeft);
    doc.text(`Score: ${correct} / ${state.activeQuestions.length} (${((correct/state.activeQuestions.length)*100).toFixed(1)}%)`, 20, 30);
    doc.text(`Time Spent: ${timeSpent}`, 20, 40);
    doc.text(`Category: ${state.category}`, 20, 50);
    let catScores = {};
    CATEGORIES.forEach(cat => catScores[cat] = [0,0]);
    state.activeQuestions.forEach((q,i) => {
      catScores[q.c][1]++;
      if (state.answers[i] === q.a) catScores[q.c][0]++;
    });
    let y = 60;
    doc.text("Category Scores:", 20, y);
    CATEGORIES.filter(c => catScores[c][1] > 0).forEach(cat => {
      y += 10;
      doc.text(`${cat}: ${catScores[cat][0]}/${catScores[cat][1]}`, 20, y);
    });
    let missedQuestions = state.activeQuestions
      .map((q,i) => state.answers[i] !== q.a ? `${i+1}. ${q.q}\n   Your answer: ${q.o[state.answers[i]]}\n   Correct: ${q.o[q.a]}\n   Explanation: ${q.e}` : '')
      .filter(x => x);
    if (missedQuestions.length > 0) {
      y += 10;
      doc.text("Missed Questions:", 20, y);
      missedQuestions.forEach((q, i) => {
        y += 20;
        doc.text(q, 20, y, { maxWidth: 160 });
      });
    }
    doc.save("BoardScope_by_CW_Results.pdf");
  } catch (e) {
    console.error("Failed to export PDF:", e);
    alert("Failed to export PDF. Please ensure jsPDF is loaded correctly.");
  }
}

function calcClear() {
  document.getElementById('calc-display').value = '0';
}

function calcBack() {
  let display = document.getElementById('calc-display');
  display.value = display.value.slice(0, -1) || '0';
}

function calcInsert(val) {
  let display = document.getElementById('calc-display');
  if (display.value === '0' && val !== '.') display.value = '';
  display.value += val;
}

function calcSquare() {
  let display = document.getElementById('calc-display');
  try {
    display.value = math.evaluate(`(${display.value})^2`);
  } catch (e) {
    display.value = 'Error';
  }
}

function calcSqrt() {
  let display = document.getElementById('calc-display');
  try {
    display.value = math.evaluate(`sqrt(${display.value})`);
  } catch (e) {
    display.value = 'Error';
  }
}

function calcEquals() {
  let display = document.getElementById('calc-display');
  try {
    display.value = math.evaluate(display.value);
  } catch (e) {
    display.value = 'Error';
  }
}

function toggleCalculator() {
  let modal = document.getElementById('calculatorModal');
  modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
}

function handleKeydown(e) {
  if (state.step !== "test") return;
  if (e.key >= '1' && e.key <= '4') {
    choose(parseInt(e.key) - 1);
  } else if (e.key === 'ArrowLeft' && state.qIdx > 0) {
    prevQ();
  } else if (e.key === 'ArrowRight' && state.qIdx < state.activeQuestions.length - 1) {
    nextQ();
  } else if (e.key.toLowerCase() === 'm') {
    toggleMark();
  } else if (e.key === 'Escape') {
    goMenu();
  }
}

let isDragging = false;
let currentX, currentY, xOffset = 0, yOffset = 0;

document.getElementById('calculatorHeader').addEventListener('mousedown', (e) => {
  isDragging = true;
  currentX = e.clientX - xOffset;
  currentY = e.clientY - yOffset;
});

document.addEventListener('mousemove', (e) => {
  if (isDragging) {
    e.preventDefault();
    xOffset = e.clientX - currentX;
    yOffset = e.clientY - currentY;
    let modal = document.getElementById('calculatorModal');
    modal.style.right = 'auto';
    modal.style.bottom = 'auto';
    modal.style.left = `${e.clientX - currentX}px`;
    modal.style.top = `${e.clientY - currentY}px`;
  }
});

document.addEventListener('mouseup', () => {
  isDragging = false;
});

if (state.step === "menu") {
  renderMenu();
  toggleCalcVisibility();
} else if (state.step === "test") {
  renderTest();
  toggleCalcVisibility();
  if (state.timerActive) startTimer();
} else if (state.step === "results") {
  renderResults();
  toggleCalcVisibility();
}
  </script>
</body>
</html>